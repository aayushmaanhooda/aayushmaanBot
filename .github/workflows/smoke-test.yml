name: AayushBot Smoke Test

on:
  push:
    branches:
      - master

jobs:
  smoke-test:
    runs-on: ubuntu-latest

    steps:
      - name: Test /health endpoint
        run: |
          RESPONSE=$(curl -s --connect-timeout 15 --max-time 30 -o /tmp/health.json -w "%{http_code}" \
            "${{ secrets.EC2_BASE_URL }}/health")

          echo "Status: $RESPONSE"
          cat /tmp/health.json
          [ "$RESPONSE" = "200" ] && echo "‚úÖ /health passed" || { echo "‚ùå /health failed"; exit 1; }

      - name: Test /chat endpoint
        run: |
          RESPONSE=$(curl -s --connect-timeout 15 --max-time 120 -o /tmp/chat.json -w "%{http_code}" \
            -X POST "${{ secrets.EC2_BASE_URL }}/chat" \
            -H "Content-Type: application/json" \
            -d '{"message": "Who is Aayushmaan?", "thread_id": "ci-smoke-test"}')

          echo "Status: $RESPONSE"
          cat /tmp/chat.json

          if [ "$RESPONSE" != "200" ]; then
            echo "‚ùå /chat returned $RESPONSE"
            exit 1
          fi

          REPLY=$(python3 -c "import sys,json; print(json.load(sys.stdin).get('reply',''))" < /tmp/chat.json)
          [ -n "$REPLY" ] && echo "‚úÖ /chat passed" || { echo "‚ùå empty reply"; exit 1; }

      - name: All smoke tests passed
        run: echo "üöÄ All endpoints healthy"
