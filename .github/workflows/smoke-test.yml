name: AayushBot Smoke Test

on:
  push:
    branches:
      - master

jobs:
  smoke-test:
    runs-on: ubuntu-latest

    steps:
      - name: Debug connectivity
        run: |
          URL="${{ secrets.EC2_BASE_URL }}"
          HOST=$(echo "$URL" | sed 's|https\?://||' | sed 's|/.*||')
          echo "Host: $HOST"
          echo "--- DNS lookup ---"
          nslookup "$HOST" || true
          echo "--- Curl verbose ---"
          curl -v --connect-timeout 10 "$URL/health" 2>&1 || true

      - name: Test /health endpoint
        run: |
          RESPONSE=$(curl -s --connect-timeout 15 --max-time 30 -o /tmp/health.json -w "%{http_code}" \
            "${{ secrets.EC2_BASE_URL }}/health")

          echo "Status: $RESPONSE"
          cat /tmp/health.json
          [ "$RESPONSE" = "200" ] && echo "/health passed" || { echo "/health failed"; exit 1; }

      - name: Test /chat endpoint
        run: |
          RESPONSE=$(curl -s --connect-timeout 15 --max-time 120 -o /tmp/chat.json -w "%{http_code}" \
            -X POST "${{ secrets.EC2_BASE_URL }}/chat" \
            -H "Content-Type: application/json" \
            -d '{"message": "Who is Aayushmaan?", "thread_id": "ci-smoke-test"}')

          echo "Status: $RESPONSE"
          cat /tmp/chat.json

          if [ "$RESPONSE" != "200" ]; then
            echo "/chat returned $RESPONSE"
            exit 1
          fi

          REPLY=$(python3 -c "import sys,json; print(json.load(sys.stdin).get('reply',''))" < /tmp/chat.json)
          [ -n "$REPLY" ] && echo "/chat passed" || { echo "empty reply"; exit 1; }

      - name: All smoke tests passed
        run: echo "ðŸš€ All endpoints healthy"
