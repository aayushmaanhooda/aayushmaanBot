name: AayushBot Smoke Test

on:
  push:
    branches:
      - master

jobs:
  smoke-test:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
      PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      LANGSMITH_TRACING: "false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: pip install -r backend/requirements.txt

      - name: Start server
        run: |
          cd backend/app
          python main.py &
          echo "Waiting for server to start..."
          for i in $(seq 1 60); do
            if curl -s http://localhost:8000/health > /dev/null 2>&1; then
              echo "Server is up after ${i}s"
              break
            fi
            sleep 1
          done

      - name: Test /health endpoint
        run: |
          RESPONSE=$(curl -s --max-time 10 -o /tmp/health_response.json -w "%{http_code}" \
            http://localhost:8000/health)

          echo "Status code: $RESPONSE"
          cat /tmp/health_response.json

          if [ "$RESPONSE" != "200" ]; then
            echo "‚ùå /health returned status $RESPONSE"
            exit 1
          fi

          echo "‚úÖ /health passed"

      - name: Test /chat endpoint
        run: |
          RESPONSE=$(curl -s --max-time 120 -o /tmp/chat_response.json -w "%{http_code}" \
            -X POST http://localhost:8000/chat \
            -H "Content-Type: application/json" \
            -d '{"message": "Who is Aayushmaan?", "thread_id": "ci-test-123"}')

          echo "Status code: $RESPONSE"
          echo "Response body:"
          cat /tmp/chat_response.json

          if [ "$RESPONSE" != "200" ]; then
            echo "‚ùå /chat returned status $RESPONSE"
            exit 1
          fi

          REPLY=$(cat /tmp/chat_response.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('reply',''))")
          echo "Reply: $REPLY"

          if [ -z "$REPLY" ]; then
            echo "‚ùå /chat returned empty reply"
            exit 1
          fi

          echo "‚úÖ /chat passed"

      - name: Test /voice-chat endpoint
        run: |
          python3 -c "
          import struct, wave
          with wave.open('/tmp/test.wav', 'w') as w:
              w.setnchannels(1)
              w.setsampwidth(2)
              w.setframerate(16000)
              w.writeframes(struct.pack('<' + 'h' * 16000, *([0] * 16000)))
          "

          RESPONSE=$(curl -s --max-time 120 -o /tmp/voice_response.json -w "%{http_code}" \
            -X POST http://localhost:8000/voice-chat \
            -F "audio=@/tmp/test.wav")

          echo "Status code: $RESPONSE"
          echo "Response body:"
          cat /tmp/voice_response.json

          if [ "$RESPONSE" = "400" ]; then
            echo "‚ö†Ô∏è  /voice-chat returned 400 (silent audio, transcription empty) ‚Äî endpoint is reachable"
            echo "‚úÖ /voice-chat passed (endpoint alive)"
            exit 0
          fi

          if [ "$RESPONSE" != "200" ]; then
            echo "‚ùå /voice-chat returned status $RESPONSE"
            exit 1
          fi

          echo "‚úÖ /voice-chat passed"

      - name: All smoke tests passed
        run: echo "üöÄ All endpoints are healthy"
